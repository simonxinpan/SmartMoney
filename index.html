// --- API 配置 ---
const apiKey = 'ZYpXufkAUGUmzHLH5F4WeFFhStiaL7xu'; // 替换为您自己的FMP API Key

// --- 辅助函数：创建卡片HTML ---
function createCardHTML(item) {
    return `
        <div class="feed-card">
            <img src="https://via.placeholder.com/50/6c757d/ffffff?text=${item.logoText}" alt="${item.firmName}" class="logo">
            <div class="content">
                <p class="title">
                    <a href="#" class="clickable">${item.firmName}</a> 
                    <span class="tag tag-${item.type} clickable-tag">${item.action}</span>
                </p>
                <p class="description">
                    ${item.description}
                </p>
                <p class="meta">数据来源: ${item.source} | 日期: ${item.date}</p>
            </div>
        </div>
    `;
}

// --- 主函数：获取多种数据并统一渲染 ---
async function fetchAllSmartMoneyData() {
    const feedContainer = document.getElementById('feed-container');
    feedContainer.innerHTML = '<div class="feed-card"><p>正在加载多种聪明钱动态...</p></div>';
    
    console.log('开始获取多种聪明钱数据...');

    try {
        // --- 数据请求清单 ---
        // 1. 请求内部人交易 (最近100条)
        const insiderTradingUrl = `https://financialmodelingprep.com/api/v4/insider-trading?page=0&apikey=${apiKey}`;
        //好的，收到！这张截图**价值连城**，它清晰地告诉我们：

1.  **代码已无语法错误**: `SyntaxError`消失了。
2.  **API调用已成功**: 您在控制台亲眼看到了“正在从FMP获取真实数据...”和“成功获取到数据！”。

**您已经跨过了从0到1最难的一步！**

现在，我们来解决新的问题：“ 2. 请求巴菲特(Berkshire)的持仓
        const berkshireUrl = `https://financialmodelingprep.com/api/v3/form-13f?cik=0001067983&apikey=${apiKey}`;
        // 3. 请求木头姐(ARK)的ETF持仓
        const arkkUrl = `https://financialmodelingprep.com/api/v3/etf-holder/ARKK?apikey=${apiKey}`;

        // 使用Promise.allSettled来同时发起所有请求，无论成败都会返回结果
        const responses = await Promise.allSettled([
            fetch(insiderTradingUrl),
            fetch(berkshireUrl),
            fetch(arkkUrl)
        ]);

        console.log('所有API请求已完成，正在处理数据...');

        let combinedData = [];

        // --- 数据处理与转换 ---
        // 处理内部人交易数据
        if (responses[0].status === 'fulfilled' && responses[0].value.ok) {
            const insiderData = await responses[0].value.json();
            insiderData.slice(0, 5).forEach(item => {
                combinedData.push({
                    firmName: `${item.insiderName} (${item.insiderRelation})`,
                    action: item.transactionType === 'P-Purchase' ? '内部人买入' : '内部人卖出',
                    description: `交易了 <a href="#" class="clickable"><strong>${item.companyName} (${item.symbol})</strong></a> ${item.transactionShares.toLocaleString()} 股`,
                    source: 'Form 4',
                    date: item.filingDate,
                    type: item.transactionType === 'P-Purchase' ? 'insider' : 'sell',
                    logoText: 'Insider'
                });
            });
        }

        // 处理巴菲特持仓数据
        if (responses[1].status === 'fulfilled' && responses[1].value.ok) {
            const berkshireData = await responses[1].value.json();
            berkshireData.slice(0, 2).forEach(item => {
                combinedData.push({
                    firmName: '伯克希尔哈撒韦',
                    action: '持仓',
                    description: `持有 <a href="#" class="clickable"><strong>${item.nameOfIssuer} (${item.cusip})</strong></a> ${item.shares.toLocaleString()} 股`,
                    source: '13F文件',
                    date: item.date,
                    type: 'buy',
                    logoText: 'BH'
                });
            });
        }

        // 处理木头姐持仓数据
        if (responses[2].status === 'fulfilled' && responses[2].value.ok) {
            const arkkData = await responses[2].value.json();
            arkkData.slice(0, 3).forEach(item => {
                combinedData.push({
                    firmName: '方舟基金 (ARK Invest)',
                    action: 'ETF持仓',
                    description: `持有 <a href="#" class="clickable"><strong>${item.name} (${item.asset})</strong></a> ${item.sharesNumber.toLocaleString()} 股`,
                    source: 'ETF持仓报告',
                    date: item.date,
                    type: 'buy',
                    logoText: 'A'
                });
            });
        }
        
        // --- 最终渲染 ---
        feedContainer.innerHTML = ''; // 清空加载状态
        if (combinedData.length > 0) {
            // 按日期倒序排列
            combinedData.sort((a, b) => new Date(b.date) - new Date(a.date));
            combinedData.forEach(item => {
                feedContainer.innerHTML += createCardHTML(item);
            });
        } else {
            feedContainer.innerHTML = '<**为什么页面上没有显示数据？**”

---

### 问题分析：为什么页面是空白的？

您在控制台看到的`[]`符号，是一个空的数组。这意味着：

**我们的代码成功地连接到了FMP，FMP也成功地返回了结果，但结果是“空的”，里面没有任何持仓数据。**

**最可能的原因：**

FMP提供的13F数据可能有一定的**延迟**，或者我们查询的`cik='0001061981'`（桥水基金）在**当前这个API端点（endpoint）**下，恰好没有返回最近的数据。

这在API开发中非常常见。我们的代码逻辑是“如果数据是空的，就不显示任何东西”，所以页面看起来是空白的。

---

### 解决方案：扩大搜索范围，并增加容错处理

我们将进行一次重要的代码升级，来解决这个问题并让我们的产品更健壮。

**升级策略：**

1.  **查询更多机构**: 我们不再只查询桥水，而是同时查询**多个知名机构**，并把他们的持仓数据合并在一起。这样，总能有数据显示出来。
2.  **增加用户反馈**: 如果所有查询结果都是空的，我们不能让页面空白。我们必须在页面上明确地告诉用户“**未能找到相关动态**”，而不是让他困惑。

---

### 第六步：升级为多机构查询引擎

**您的任务 (预计耗时: 5分钟)**:

1.  **回到GitHub**，再次进入`index.html`的编辑模式。
2.  **定位到`<script>`区域**: 滚动到最下方。
3.  **完全替换`<script>`内容**: 再次清空从`<script>`到`</script>`的所有内容，然后将下面我为您准备的**【JS代码V3 - 多机构查询版】**，完整地复制并粘贴进去。
4.  **替换API Key**: 再次确认顶部的`apiKey`是您自己的。
5.  **提交更改**，等待Netlify自动部署。

div class="feed-card"><p>未能从任何API获取到有效数据。</p></div>';
        }

    } catch (error) {
        console.error('处理数据时发生严重错误:', error);
        feedContainer.innerHTML = `<div class="feed-card"><p style="color:red;">数据处理失败！错误信息: ${error.message}。</p></div>`;
    }
}

// 页面加载时自动执行我们的主函数
document.addEventListener('DOMContentLoaded', fetchAllSmartMoneyData);
